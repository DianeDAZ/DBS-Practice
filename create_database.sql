CREATE DATABASE pharmacy_ms;
USE pharmacy_ms;
-- 创表
CREATE TABLE IF NOT EXISTS employee              -- 员工信息表
(
    e_id CHAR(4) NOT NULL ,  -- 员工id
    e_name CHAR(8) NOT NULL ,  -- 姓名
    age TINYINT NOT NULL ,  -- 年龄
    sex CHAR(2) NOT NULL ,  -- 性别
    education CHAR(4) NOT NULL ,  -- 学历
    position CHAR(8) NOT NULL , -- 职位
    id_number CHAR(18) NOT NULL ,  -- 身份证号
    tel VARCHAR(20) NULL ,  -- 联系电话
    PRIMARY KEY (e_id)
);
INSERT INTO employee
VALUES ('0001', '张三', 25, '男', '本科', '销售员', '578697788340839894', '15968545962'),
       ('0002', '李四', 27, '男', '本科', '库房管理员', '571114788340839894', '13944547862'),
       ('0003', '王福', 32, '男', '高中', '销售员', '578234786970839894', '17968546962'),
       ('0004', '李华', 22, '女', '高中', '收银员', '578239998340839894', '13968541462'),
       ('0005', '张明杰', 45, '男', '专科', '收银员', '588234788340839894', '17968497862'),
       ('0006', '刘丹', 32, '女', '本科', '销售经理', '578234788340698894', '15968777862'),
       ('0007', '赵富民', 27, '男', '本科', '库房管理员', '578234747840839894', '19568547862'),
       ('0008', '周峰', 24, '男', '专科', '采购员', '578234788340333894', '13968541462'),
       ('0009', '吴芳', 22, '女', '本科', '采购员', '578234788399139894', '15968547962'),
       ('0010', '刘丽', 26, '女', '本科', '会计', '578234719640839894', '15968547810'),
       ('0011', '王伟峰', 25, '男', '硕士', '会计', '578234788222839894', '13968547162'),
       ('0012', '张敏', 35, '女', '本科', '采购员', '578698788340839894', '17968540262'),
       ('0013', '冯斌', 33, '男', '本科', '采购员', '578697788123839894', '15954545962'),
       ('0014', '徐娜', 43, '女', '本科', '库房管理员', '575554788340839894', '13764547862'),
       ('0015', '杜慧秀', 31, '女', '本科', '销售员', '578234786970839894', '17961246962'),
       ('0016', '陈丽', 24, '女', '高中', '销售员', '578239667340839894', '13968555462'),
       ('0017', '张华飞', 44, '男', '专科', '收银员', '588233388340839894', '17969997862'),
       ('0018', '刘鹏', 36, '男', '专科', '销售员', '578234788888698894', '15968711862'),
       ('0019', '吴琴', 28, '女', '专科', '会计', '578234747841239894', '19568547002'),
       ('0020', '周利军', 34, '男', '本科', '采购员', '578234700040333894', '13964441462');
CREATE TABLE IF NOT EXISTS medicine              # 药品信息表
(
    m_id CHAR(4) NOT NULL ,  -- 药品货号
    m_name VARCHAR(20) NOT NULL ,  -- 品名
    type CHAR(10) NOT NULL ,  -- 类型
    specification VARCHAR(40) NOT NULL ,  -- 规格
    unit CHAR(4) ,  -- 单位
    manufacturer VARCHAR(40) NOT NULL ,  -- 生产厂家
    approval_number CHAR(17) NOT NULL ,  -- 批准文号
    stock_date DATE NOT NULL ,  -- 进货日期
    expiry_date DATE NOT NULL ,  -- 有效期
    s_id VARCHAR(40) NOT NULL , -- 供货商id
    batch_number CHAR(10) NOT NULL ,  -- 生产批号
    recorder_id CHAR(4) NOT NULL ,  -- 记录人id
    purchase_amount SMALLINT ,  -- 进货数量
    trade_price DECIMAL(5, 2) NOT NULL ,  -- 批发价
    purchase_price DECIMAL(5, 2) NOT NULL ,  -- 进价
    retail_price DECIMAL(5, 2) NOT NULL ,  -- 零售价
    PRIMARY KEY (m_id)
);
INSERT INTO medicine
VALUES ('1001', '东山感冒片', '解热镇痛', '0.32g/片', 'g', '广东白云制药厂', 'Z20075489', '2018-11-12', '2020-08-30', '3004', '121233-12', '0001', 1234, 234.23, 110, 324.3),
       ('1002', '清热感冒片', '解热镇痛', '0.12g/片', 'g', '四川小草制药厂', 'Z21236889', '2018-09-11', '2020-08-11', '3004', '127773-12', '0002', 4234, 233.4, 220, 324.5),
       ('1003', '法法感冒液', '解热镇痛', '0.32ml/支', 'ml', '云南太阳制药厂', 'Z55526889', '2018-01-13', '2020-08-01', '3004', '678323-12', '0002', 321, 233.24, 120, 354.3),
       ('1004', '东山感冒颗粒', '解热镇痛', '0.30g/颗', 'g', '西安小鸟制药厂', 'Z29096889', '2018-02-23', '2020-08-02', '3003', '901323-12', '0003', 311, 212.34, 150, 891.1),
       ('1005', '估计感冒片', '解热镇痛', '0.02g/片', 'g', '北京风雨制药厂', 'Z20018689', '2018-03-11', '2020-08-03', '3001', '128883-12', '0004', 3298, 233.4, 110, 312.4),
       ('1006', '锐感冒液', '解热镇痛', '0.33ml/片', 'ml', '南京石头制药厂', 'Z20037689', '2018-04-24', '2020-08-04', '3001', '121103-12', '0005', 4032, 233.34, 100, 343.2),
       ('1007', '积分感冒颗粒', '解热镇痛', '0.32g/颗', 'g', '北海大树制药厂', 'Z29856889', '2018-05-10', '2020-08-06', '3003', '324323-12', '0005', 4312, 239.04, 110, 891.2),
       ('1008', '维生素A', '维生素营养', '0.11g/片', 'g', '广西健康制药厂', 'Z20021729', '2018-05-09', '2020-08-05', '3003', '120901-12', '0006', 742, 213.4, 109, 324.5),
       ('1009', '维生素B', '维生素营养', '0.66g/颗', 'g', '大连幸福制药厂', 'Z20190889', '2018-05-01', '2020-08-23', '3002', '120111-12', '0005', 423, 323.4, 110, 312.3),
       ('1010', '维生素C', '维生素营养', '0.12g/片', 'g', '四川法蒂制药厂', 'Z20000889', '2018-06-02', '2020-08-10', '3002', '120223-12', '0006', 782, 432.4, 111, 931.3),
       ('1011', '维生素D', '维生素营养', '0.89g/颗', 'g', '海南积分制药厂', 'Z20765889', '2018-08-08', '2020-08-08', '3002', '120789-12', '0005', 6178, 234.4, 112, 600.3),
       ('1012', '维生素E', '维生素营养', '0.13g/片', 'g', '福建快乐制药厂', 'Z20999889', '2018-08-15', '2020-08-12', '3002', '120312-12', '0006', 8191, 254.5, 113, 632.1),
       ('1013', '三黄片', '口腔', '0.12g/片', 'g', '北京时间制药厂', 'Z20011189', '2018-02-12', '2020-01-23', '3002', '128903-12', '0007', 3128, 234, 114.40, 320),
       ('1014', '积分片', '口腔', '0.30g/片', 'g', '西安阀门制药厂', 'Z20032389', '2018-02-21', '2020-04-11', '3001', '123333-12', '0007', 1111, 234, 115.3, 890),
       ('1015', '法尔口服液', '口腔', '0.12ml/支', 'ml', '宁夏有限制药厂', 'Z27866889', '2018-07-18', '2020-08-09', '3001', '888323-12', '0007', 2222, 116.4, 450, 770.3),
       ('1016', '滴滴颗粒', '口腔', '0.65g/颗', 'g', '大理无线制药厂', 'Z20020909', '2018-07-19', '2020-08-19', '3004', '189023-12', '0008', 333, 234, 116.5, 645.0),
       ('1017', '好得快片', '口腔', '0.39g/片', 'g', '湖北距离制药厂', 'Z20028909', '2018-08-20', '2020-08-13', '3001', '167823-12', '0008', 4333, 234, 116.1, 623.4),
       ('1018', '利利片', '口腔', '0.12g/片', 'g', '湖南公检制药厂', 'Z20026444', '2018-11-21', '2020-08-12', '3001', '123243-12', '0009', 4445, 234, 117.1, 643.0),
       ('1019', '偶记口服液', '口腔', '0.42g/支', 'g', '浙江激发制药厂', 'Z21236889', '2018-11-24', '2020-08-12', '3002', '444323-12', '009', 666, 234, 118.40, 435.2),
       ('1020', '机构颗粒', '口腔', '0.37g/颗', 'g', '河北解放制药厂', 'Z20025689', '2018-10-25', '2020-08-12', '3002', '128973-12', '0009', 4120, 234, 118.5, 999.0);

CREATE TABLE IF NOT EXISTS delivery_log          # 药品出库登记表
(
    delivery_id CHAR(8) NOT NULL ,  -- 库单流水号id
    recorder_id CHAR(4) NOT NULL ,  -- 记录人id
    collector_id CHAR(4) NOT NULL ,  -- 领货人id
    delivery_date DATE NOT NULL ,  -- 出库日期
    m_id CHAR(4) NOT NULL,  -- 药品id
    delivery_amount SMALLINT,  -- 出库数量
    PRIMARY KEY (delivery_id)
);
INSERT delivery_log
VALUES
('99990001','0001','0002','2019-09-21','1001',2300),
('99990002','0001','0002','2019-09-25','1002',900),
('99990003','0001','0007','2019-09-28','1003',1400),
('99990004','0001','0014','2019-10-08','1004',500),
('99990005','0001','0007','2019-10-20','1005',300),
('99990006','0003','0002','2019-09-04','1006',666),
('99990007','0003','0007','2019-09-05','1007',1211),
('99990008','0003','0014','2019-09-14','1008',1322),
('99990009','0003','0007','2019-09-13','1009',945),
('99990010','0003','0002','2019-09-02','1010',740),
('99990011','0005','0002','2019-11-14','1011',502),
('99990012','0005','0002','2019-10-17','1012',1521),
('99990013','0005','0014','2019-11-22','1013',744),
('99990014','0005','0007','2019-11-01','1014',942),
('99990015','0005','0002','2019-11-05','1015',452),
('99990016','0007','0014','2019-11-11','1016',358),
('99990017','0007','0014','2019-12-17','1017',1742),
('99990018','0007','0007','2019-09-12','1018',633),
('99990019','0007','0002','2019-09-14','1019',1204),
('99990020','0007','0014','2019-12-09','1020',1024);
SELECT *
FROM delivery_log
WHERE delivery_date >= '2019-1-1' AND delivery_date <= '2019-9-1';
CREATE TABLE IF NOT EXISTS sale_log              # 药品销售记录
(
    sale_id CHAR(8) NOT NULL ,  -- 销售流水号id
    m_id CHAR(4) NOT NULL ,  -- 药品id
    saler_id CHAR(4) NOT NULL ,  -- 销售员id
    sale_date DATE NOT NULL,  -- 销售日期
    sale_amount SMALLINT,  -- 销售数量
    PRIMARY KEY (sale_id)
);
SELECT e_name, sum(retail_price)
FROM pharmacy_ms.employee, sale_log, medicine
WHERE sale_log.m_id = medicine.m_id AND
      e_id = saler_id AND
      saler_id = '0001' AND
      sale_date = '2019-10-1';
SELECT sale_date, sum(retail_price)
FROM sale_log, medicine
WHERE sale_log.m_id = medicine.m_id AND
      sale_date = '2019-10-1';
SELECT sale_log.*
FROM medicine, sale_log
WHERE sale_log.m_id=medicine.m_id AND
      type='维生素营养';
SELECT sale_log.*
FROM medicine, sale_log
WHERE sale_log.m_id=medicine.m_id AND sale_date>='2019-10-1' AND sale_date <='2019-11-1' AND
      m_name='东山感冒片';
SELECT sale_log.saler_id, sale_log.m_id, sum(sale_amount), sum(retail_price), sum(retail_price - trade_price), sum(retail_price - trade_price) / sum(trade_price)
FROM sale_log, medicine
WHERE sale_log.m_id=medicine.m_id AND sale_date>='2019-10-1' AND sale_date <='2019-11-1' AND
      sale_log.saler_id='0001'
GROUP BY sale_log.m_id
ORDER BY sum(retail_price) DESC;
INSERT INTO sale_log
VALUES
('77770001','1001','0001','2019-10-01', 12),
('77770002','1002','0001','2019-10-01', 11),
('77770003','1003','0001','2019-10-01', 75),
('77770004','1001','0003','2019-10-01', 45),
('77770005','1002','0006','2019-10-01', 21),
('77770006','1002','0005','2019-10-01', 72),
('77770007','1003','0006','2019-10-02', 46),
('77770008','1003','0008','2019-10-02', 42),
('77770009','1003','0001','2019-10-02', 74),
('77770010','1004','0003','2019-10-02', 13),
('77770011','1001','0003','2019-10-02', 56),
('77770012','1001','0006','2019-10-02', 11),
('77770013','1003','0006','2019-10-02', 64),
('77770014','1004','0008','2019-10-02', 34),
('77770015','1005','0008','2019-10-03', 74),
('77770016','1006','0006','2019-10-03', 23),
('77770017','1007','0005','2019-10-03', 26),
('77770018','1008','0005','2019-10-03', 47),
('77770019','1009','0001','2019-10-03', 22),
('77770020','1001','0006','2019-10-03', 68),
('77770021','1001','0001','2019-10-03', 12),
('77770022','1002','0001','2019-10-03', 78),
('77770023','1003','0001','2019-10-03', 22),
('77770024','1004','0003','2019-10-03', 32),
('77770025','1005','0006','2019-10-04', 54),
('77770026','1006','0005','2019-10-04', 74),
('77770027','1007','0006','2019-10-04', 23),
('77770028','1008','0008','2019-10-04', 47),
('77770029','1009','0001','2019-10-04', 43),
('77770030','1001','0003','2019-10-04', 23),
('77770031','1001','0003','2019-10-04', 76),
('77770032','1002','0006','2019-10-04', 98),
('77770033','1003','0003','2019-10-05', 12),
('77770034','1004','0003','2019-10-05', 77),
('77770035','1005','0002','2019-10-05', 12),
('77770036','1006','0006','2019-10-05', 55),
('77770037','1007','0005','2019-10-05', 12),
('77770038','1008','0002','2019-10-05', 65),
('77770039','1009','0001','2019-10-05', 12),
('77770040','1008','0005','2019-10-05', 8);
CREATE TABLE IF NOT EXISTS counter               #  柜台药品信息
(
    m_id CHAR(8) NOT NULL ,  -- 药品id
    settle_status CHAR(6) NOT NULL ,  -- 结款状态
    c_name VARCHAR(10) NOT NULL,  -- 柜台名称
    amount SMALLINT,  -- 数量
    PRIMARY KEY (m_id, c_name),
    FOREIGN KEY (m_id) REFERENCES medicine(m_id)
);
SELECT m_name, sum(amount), sum(medicine.retail_price)
FROM counter, medicine
WHERE counter.m_id = medicine.m_id AND m_name='维生素A'
GROUP BY counter.m_id;
INSERT INTO counter
VALUES
('1001','已结款','A', 12),
('1002','未结款','A', 34),
('1003','已结款','A', 42),
('1004','已结款','A', 34),
('1005','未结款','A', 12),
('1006','已结款','B', 34),
('1007','已结款','B', 54),
('1008','未结款','B', 22),
('1009','已结款','B', 12),
('1010','未结款','B', 5),
('1011','已结款','C', 54),
('1012','未结款','C', 1),
('1013','已结款','C', 4),
('1014','未结款','C', 36),
('1015','已结款','C', 34),
('1016','已结款','D', 64),
('1017','已结款','D', 44),
('1018','已结款','D', 34),
('1019','未结款','D', 75),
('1020','已结款','D', 65);

CREATE TABLE IF NOT EXISTS supplier              #  供货商信息表
(
    s_id  CHAR(4) NOT NULL ,  -- 供货商号
    m_id CHAR(4) NOT NULL ,  -- 药品id
	s_name VARCHAR(40) NOT NULL,  -- 供货商名
	tel CHAR(11) , -- 电话
	PRIMARY KEY (s_id, m_id),
	FOREIGN KEY (m_id) REFERENCES medicine(m_id)
);
INSERT supplier
VALUES ('9999', '1001', '公司', '99999999999');
INSERT INTO supplier
VALUES
('3001','1001','四川有限公司','11233000233'),
('3001','1002','四川有限公司','11233300233'),
('3001','1003','四川有限公司','17638652000'),
('3001','1004','四川有限公司','18905431000'),
('3001','1005','四川有限公司','10785723600'),
('3001','1007','四川有限公司','18429785800'),
('3001','1008','四川有限公司','18428852500'),
('3001','1009','四川有限公司','18429883700'),
('3001','1011','四川有限公司','18539882100'),
('3001','1012','四川有限公司','18539042300'),
('3001','1013','四川有限公司','18593895200'),
('3001','1014','四川有限公司','19648723000'),
('3001','1016','四川有限公司','19539844200'),
('3001','1017','四川有限公司','18958343400'),
('3001','1018','四川有限公司','19639852200'),
('3001','1019','四川有限公司','19640998300'),
('3002','1001','重庆有限公司','19690454200'),
('3002','1003','重庆有限公司','19059672100'),
('3002','1005','重庆有限公司','18960029200'),
('3002','1007','重庆有限公司','12738599800'),
('3002','1013','重庆有限公司','14985063200'),
('3002','1014','重庆有限公司','12848959400'),
('3002','1017','重庆有限公司','19076933200'),
('3002','1018','重庆有限公司','19940494800'),
('3002','1019','重庆有限公司','19060992600'),
('3002','1020','重庆有限公司','10907993200'),
('3003','1003','贵州有限公司','19503893600'),
('3003','1006','贵州有限公司','18853082100'),
('3003','1009','贵州有限公司','10959882700'),
('3003','1010','贵州有限公司','19503984000'),
('3003','1013','贵州有限公司','17274842100'),
('3003','1016','贵州有限公司','17277453600'),
('3003','1017','贵州有限公司','18590603200'),
('3003','1019','贵州有限公司','15309052800'),
('3003','1020','贵州有限公司','19060343200'),
('3004','1001','云南有限公司','15938963600'),
('3004','1004','云南有限公司','19060764300'),
('3004','1009','云南有限公司','19508985600'),
('3004','1015','云南有限公司','19508274600'),
('3004','1020','云南有限公司','15987837900');
SELECT DISTINCT medicine.stock_date, medicine.m_id, medicine.m_name, medicine.purchase_price, supplier.s_name
FROM medicine, supplier
WHERE supplier.s_id = medicine.s_id AND medicine.stock_date >= '2018-1-1' AND medicine.stock_date <= '2018-2-1';

CREATE TABLE IF NOT EXISTS counter_log           # 入柜记录
(
    counter_log_id CHAR(8) NOT NULL , -- 入柜流水号id
    m_id CHAR(8) NOT NULL ,  -- 药品id
    recorder_id CHAR(8) NOT NULL ,  -- 记录人id
    counter_date DATE NOT NULL ,  -- 入柜日期
    c_name VARCHAR(10) NOT NULL,  -- 柜台名称
    counter_amount SMALLINT,  -- 入柜数量
    PRIMARY KEY (counter_log_id)
);
SELECT *
FROM counter_log
WHERE m_id='1001' AND counter_date <= '2019-10-7';
SELECT *
FROM counter_log;
INSERT INTO counter_log
VALUES
('88880001','1001','0001','2019-10-01','A',123),
('88880002','1002','0001','2019-10-03','A',32),
('88880003','1003','0001','2019-10-05','A',312),
('88880004','1004','0001','2019-10-07','A',321),
('88880005','1005','0001','2019-10-09','A',54),
('88880006','1006','0003','2019-09-01','B',65),
('88880007','1007','0003','2019-09-03','B',33),
('88880008','1008','0003','2019-09-05','B',66),
('88880009','1009','0003','2019-09-07','B',111),
('88880010','1010','0003','2019-09-09','B',222),
('88880011','1011','0005','2019-11-04','C',77),
('88880012','1012','0005','2019-10-06','C',89),
('88880013','1013','0005','2019-11-21','C',99),
('88880014','1014','0005','2019-10-24','C',133),
('88880015','1015','0005','2019-11-04','C',111),
('88880016','1016','0007','2019-11-04','D',63),
('88880017','1017','0007','2019-12-23','D',89),
('88880018','1018','0007','2019-09-11','D',123),
('88880019','1019','0007','2019-09-14','D',98),
('88880020','1020','0007','2019-11-25','D',112);

SET FOREIGN_KEY_CHECKS = 0;
DELETE FROM medicine
WHERE m_id='9999';
SET FOREIGN_KEY_CHECKS =1;

SET FOREIGN_KEY_CHECKS = 0;
DELETE FROM employee
WHERE e_id='9999';
SET FOREIGN_KEY_CHECKS =1;

UPDATE supplier SET s_name='好公司'
WHERE s_id='3001' AND m_id = '1001'